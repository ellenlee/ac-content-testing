## TDD 實作 - 開關冷氣

上面兩章分別介紹了 TDD 概念和流程，這一張我們要從 Rails 的角度出發，試試看把 TDD 和 Rails 結合！在你準備開始用 TDD 開發之前，讓我們先用不同的角度帶你走過一次，接觸 TDD 開發的可能會遇到的狀況和情境。在面對每一個功能的時候，我們要記得五個核心步驟概念：（<mark>Ellen: 這五個核心和之前說的不同，要如何修改成一致？</mark>）

1. 確定目標功能
2. 排除外部因素
3. 設定預期結果
4. 呼叫目標功能
5. 判斷實際結果等於預期結果

### 從 MVC 看測試的優先順序

剛開始嘗試寫測試，我們通常會依照 MVC 的架構分別撰寫不同層級的測試，先寫 model 的測試，然後是 controller，最後才是 view。為什麼會是這個順序呢？原因很簡單，因為 model 是邏輯上最不容易改變，卻又最關鍵的地方。而 view 比較常會改變，而且改變的內容通常不會太重要。

|          |  改動頻率  |  重要度  |  難易度   |  撰寫詳細度 |
|----------|----------|----------|----------|-----------|
|view      |    高    |    低    |    低     |    低     |
|model     |    低    |    高    |    中     |    中     |
|controller|    中    |    中    |    中     |    高     |

### Model

拿冷氣遙控器的例子來看，我們有一個 model `冷氣.rb`。首先，我們要先確認 `判斷是否開啟` 這個方法的用途和格式，他是一個 model instance level 的方法，然後我們預期他的回傳值是 boolean。

```
用來判斷冷氣是否開啟，回傳 boolean
```

再來我們要把呼叫這個方法的預期結果也列出來

```
如果冷氣開啟，預期呼叫這個方法會回傳真
如果冷氣關閉，預期呼叫這個方法會回傳假
```

第三步，呼叫目標功能

```
冷氣.判斷是否開啟()
```

最後，判斷實際結果等於預期結果

```
預期(冷氣.判斷是否開啟()) == 真
```

把這四個步驟組合起來，組成 model 的完整測試

```
測試 "冷氣 判斷是否開啟 回傳值為 真" do
	假的紅外線 = 建立假的紅外線
	假設 發送問題給冷氣 回傳值為 真
	預期(冷氣.判斷是否開啟(假的紅外線)) == 真
end

測試 "冷氣 判斷是否開啟 回傳值為 假" do
	假的紅外線 = 建立假的紅外線
	假設 發送問題給冷氣 回傳值為 假
	預期(冷氣.判斷是否開啟(假的紅外線)) == 假
end
```

在這個例子裡面，冷氣是第三方 API，我們自己定義冷氣機的回傳結果，以免測試的正確性受到外部因素影響。舉例來說，假設今天冷氣機的發射系統故障，而我們對於冷氣機的回傳結果不是我們自己定義，而是真的去跟冷氣機溝通，那麼你在跑測試的時候會發現冷氣遙控器的某些測試失敗（紅燈），但實際上是冷氣機故障，而不是冷氣遙控器。

### Controller

接著我們來試試看 controller 的測試，目標是 `冷氣遙控器` 這個 controller 裡面的 action `打開冷氣`。

跟上面一樣，第一步我們要確認 `打開冷氣` 這個 action 的用途和格式，他是一個 controller 裡面的 action，我們預期他會把冷氣打開。

```
用來打開冷氣
```

再來我們要把呼叫這個方法的預期結果也列出來

```
預期呼叫打開冷氣之後會把冷氣打開
```

第三步，呼叫目標功能

```
冷氣遙控器.打開冷氣()
```

最後，判斷實際結果等於預期結果

```
冷氣遙控器.打開冷氣()
預期(冷氣狀態) == 打開
```

把這四個步驟組合起來，組成 controller 的完整測試

```
測試 "冷氣遙控器 按下 打開冷氣按鈕 能順利打開冷氣" do
	假設 冷氣開啟狀態 為 靜止
	冷氣遙控器.打開冷氣()
   預期(冷氣狀態) == 運作中
end
```

## View

view 在冷氣遙控器裡面對應到儀表板，負責顯示目前冷氣的狀態。

第一步我們要確認這次 view 的範圍，這裡對應到的儀表板區域是負責顯示開關機狀態的區域，我們希望它顯示正確

```
儀表板上負責顯示開關的區塊正確顯示
```

第二步我們要把這個模板預期的結果列出來

```
當冷氣打開時，儀表板上負責顯示開關區域會顯示 on
當冷氣關閉時，儀表板上負責顯示開關區域會顯示 off
```

再來，呼叫模板

```
渲染 冷氣遙控器#打開冷氣 模板
```

最後，判斷實際結果等於預期結果

```
預期 儀表板 開關機狀態 == "on"
```

把這四個步驟組合起來，組成 view 的完整測試

```
測試 "儀表板上負責顯示開關的區塊正確顯示" do
	假設 冷氣開啟狀態 為 靜止
	冷氣遙控器.打開冷氣()
	預期 冷氣遙控器儀表板上 會 顯示 on
end
```

在這個單元，我們從 model、controller、view 三個層級討論了測試時的實際狀況，下個單元，我們會繼續討論「定時功能」。
